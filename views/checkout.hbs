<div class="container my-5">
    <h1 class="mb-4 text-center">Complete Your Purchase</h1>
    <div class="row g-5">
        <div class="col-lg-5 order-lg-2">
            <div class="card shadow-lg checkout-summary">
                <div class="card-header text-white">
                    <h3 class="h5 mb-0"><i class="fas fa-receipt me-2"></i>Order Summary</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush mb-4" id="cart-items-list"></ul>
                    <div id="empty-cart-message" class="text-center py-5" style="display:none;">
                        <p class="fw-semibold mb-3">Your cart is empty ðŸ›’</p>
                        <a href="/shop" class="btn btn-outline-primary btn-sm">Go shopping</a>
                    </div>
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal" class="fw-bold">â‚¬0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping (Standard):</span>
                            <span id="shipping-cost" class="fw-bold">â‚¬5.00</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                            <span>Order Total:</span>
                            <span id="order-total">â‚¬5.00</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="/shop" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Continue Shopping
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-7 order-lg-1">
            <h2 class="h4 mb-3">Delivery Details</h2>
            <form name="checkout" id="user-checkout" action="" method="get">
                <fieldset class="mb-5 p-4 border rounded shadow-sm">
                    <legend class="h5 fw-bold text-primary mb-3">Shipping Information</legend>
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="sameAddressCheck">
                        <label class="form-check-label fw-bold" for="sameAddressCheck">
                            <i class="fas fa-user-check me-2 text-success"></i>My delivery address is the same as my
                            saved User Details address.
                        </label>
                    </div>
                    <div id="delivery-details-fields" class="row g-3">
                        <div class="col-md-6">
                            <label for="getFirstName" class="form-label">First name</label>
                            <input type="text" class="form-control" id="getFirstName" name="firstname" required>
                        </div>
                        <div class="col-md-6">
                            <label for="getLastName" class="form-label">Last name</label>
                            <input type="text" class="form-control" id="getLastName" name="lastname" required>
                        </div>
                        <div class="col-12">
                            <label for="getAddress1" class="form-label">Address line 1</label>
                            <input type="text" class="form-control" id="getAddress1" name="address1" required>
                        </div>
                        <div class="col-12">
                            <label for="getAddress2" class="form-label">Address line 2 (Optional)</label>
                            <input type="text" class="form-control" id="getAddress2" name="address2">
                        </div>
                        <div class="col-12">
                            <label for="getAddress3" class="form-label">Town/City</label>
                            <input type="text" class="form-control" id="getAddress3" name="address3" required>
                        </div>
                    </div>
                </fieldset>
                <h2 class="h4 mb-3 mt-5">Payment Details</h2>
                <fieldset class="p-4 border rounded shadow-sm">
                    <legend class="h5 fw-bold text-primary mb-3">Card Information</legend>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="cardName" class="form-label">Name on Card</label>
                            <input type="text" class="form-control" id="cardName" name="cardname"
                                value="MR FIRSTNAME SURNAME" required>
                        </div>
                        <div class="col-12">
                            <label for="cardNumber" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="cardNumber" name="cardNumber"
                                value="1234 5678 9102 3456" required>
                        </div>
                        <div class="col-md-6">
                            <label for="cardExpiry" class="form-label">Expiry Date (MM/YY)</label>
                            <input type="text" class="form-control" id="cardExpiry" name="cardExpiry" value="09/27"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label for="cardCvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cardCvv" name="cardcvv" required>
                        </div>
                    </div>
                </fieldset>
                <button type="submit" id="checkout-button" class="btn btn-primary w-100 mt-5">
                    <i class="fas fa-shopping-cart me-2"></i>Pay Now
                </button>
                <div role="alert" id="payment-success" class="alert alert-success mt-3" style="display:none;">
                    <i class="fas fa-check-circle me-2"></i>
                    Payment successful! Your order has been placed.
                </div>
                <div role="alert" id="payment-failure" class="alert alert-danger mt-3" style="display:none;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Payment failed. Please check your card details and try again.
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<script>
    /* Helper functions for address loading/clearing (Stay outside DOMContentLoaded) */
    function loadUserDetails() {
        const storedDetails = localStorage.getItem('userdetails');
        let userData = null;

        if (storedDetails) {
            try {
                userData = JSON.parse(storedDetails);
            } catch (e) {
                console.error("Error parsing user details from localStorage:", e);
                return;
            }
        }

        if (userData) {
            // Define all fields to be modified (Using keys from userdetails form script)
            const fields = [
                { id: 'getFirstName', key: 'firstName' },
                { id: 'getLastName', key: 'lastName' },
                { id: 'getAddress1', key: 'address1' },
                { id: 'getAddress2', key: 'address2' },
                { id: 'getAddress3', key: 'address3' }
            ];

            // Loop and set value/disable property
            fields.forEach(field => {
                const el = document.getElementById(field.id);
                if (el) {
                    // Use key property to look up in userData
                    el.value = userData[field.key] || '';
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        /* Login Guard */
        const loggedIn = localStorage.getItem('loggedIn');
        const checkoutForm = document.getElementById('user-checkout');

        if (loggedIn !== '1') {
            const modal = document.getElementById('loginRequiredModal');

            // Show the modal if required
            if (modal && typeof bootstrap !== 'undefined') {
                new bootstrap.Modal(modal).show();
            }

            // Disable all checkout fields and buttons
            if (checkoutForm) {
                checkoutForm.querySelectorAll('input, button').forEach(el => {
                    el.disabled = true;
                });
            }
        }

        /* Core checkout elements*/
        const checkoutButton = document.getElementById('checkout-button');
        const cartItemsList = document.getElementById('cart-items-list');
        const emptyMessage = document.getElementById('empty-cart-message');
        const subtotalEl = document.getElementById('subtotal');
        const shippingCostEl = document.getElementById('shipping-cost');
        const orderTotalEl = document.getElementById('order-total');
        const shippingCost = 5.00;

        // Helper array to clear address fields
        const deliveryFields = [
            'getFirstName', 'getLastName', 'getAddress1', 'getAddress2', 'getAddress3'
        ];

        /* cart helpers */
        function getCartItems() {
            try {
                return JSON.parse(localStorage.getItem('cartItems')) || [];
            } catch {
                return [];
            }
        }

        function saveCartItems(cartItems) {
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            const totalQty = cartItems.reduce((sum, i) => sum + i.quantity, 0);
            localStorage.setItem('checkout', totalQty);

            const checkoutSpan = document.querySelector('#checkout');
            if (checkoutSpan) checkoutSpan.textContent = totalQty;
        }

        /* render cart */
        function renderCartSummary() {
            const cartItems = getCartItems();
            cartItemsList.innerHTML = '';

            if (cartItems.length === 0) {
                emptyMessage.style.display = 'block';
                if (checkoutButton) checkoutButton.disabled = true; // Added check for safety
                subtotalEl.textContent = 'â‚¬0.00';
                shippingCostEl.parentNode.style.display = 'none';
                orderTotalEl.textContent = 'â‚¬0.00';
                return;
            }

            emptyMessage.style.display = 'none';
            if (checkoutButton) checkoutButton.disabled = false; // Added check for safety

            let subtotal = 0;

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                <div>
                    <strong>${item.name}</strong><br>
                    <small>Qty: ${item.quantity} Ã— â‚¬${item.price.toFixed(2)}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-item-btn" data-id="${item.id}">
                    <i class="fas fa-trash"></i>
                </button>
            `;
                cartItemsList.appendChild(li);
            });

            subtotalEl.textContent = 'â‚¬' + subtotal.toFixed(2);
            shippingCostEl.parentNode.style.display = 'flex';
            orderTotalEl.textContent = 'â‚¬' + (subtotal + shippingCost).toFixed(2);
        }


        /* checkbox listener */
        const checkbox = document.getElementById('sameAddressCheck');
        if (checkbox) {
            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    loadUserDetails();
                } else {
                    // When unchecked: Clear fields
                    deliveryFields.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.value = ''; // Clear value
                        }
                    });
                }
            });
        }

        /* event listeners */

        /* remove item */
        cartItemsList.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-item-btn');
            if (!btn) return;

            const id = btn.dataset.id;
            let cartItems = getCartItems().filter(item => item.id != id);
            saveCartItems(cartItems);
            renderCartSummary();
        });

        /* payments */
        if (checkoutButton) { // Ensure button exists before adding listener
            checkoutButton.addEventListener('click', (e) => {
                e.preventDefault();

                if (getCartItems().length === 0) return;

                const cardNumber = document.getElementById('cardNumber').value;
                const cardCvv = document.getElementById('cardCvv').value;

                const success = cardNumber === '1234 5678 9102 3456' && cardCvv === '123';

                document.getElementById('payment-success').style.display = success ? 'block' : 'none';
                document.getElementById('payment-failure').style.display = success ? 'none' : 'block';

                if (success) {
                    localStorage.setItem('cartItems', '[]');
                    localStorage.setItem('checkout', 0);

                    const checkoutSpan = document.querySelector('#checkout');
                    if (checkoutSpan) checkoutSpan.textContent = 0;

                    renderCartSummary();
                }
            });
        }

        /* initial render */
        renderCartSummary();
    });
</script>